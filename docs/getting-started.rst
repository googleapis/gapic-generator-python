Getting Started
---------------

To use this plugin, you will need an API which is specified using a
protocol buffer. Additionally, this plugin makes some assumptions at the
margins according to `Google API design conventions`_, so following those
conventions is recommended.

Example
~~~~~~~

If you want to experiment with an already-existing API, one example is
available. (Reminder that this is still considered experimental, so apologies
for this part being a bit strange.)

You need to clone the `googleapis`_ repository from GitHub, and change to
a special branch:

.. code-block:: shell

  $ git clone git@github.com:googleapis/googleapis.git
  $ cd googleapis
  $ git checkout --track -b annotated origin/annotated

The API available as an example (thus far) is the `Google Cloud Vision`_ API,
available in the ``google/cloud/vision/v1/`` subdirectory. This will be used
for the remainder of the examples on this page.

This branch also makes available the proto specification of the configuration
itself, which is explained in :ref:`api-configuration`.

.. _googleapis: https://github.com/googleapis/googleapis/
.. _Google Cloud Vision: https://cloud.google.com/vision/


Compiling an API
~~~~~~~~~~~~~~~~

To get a client library, you need to both compile the proto descriptors
into compiled message types (which is functionality built into ``protoc``)
and also into a client library (which is what this plugin does).

These can be done in the same step. ``protoc`` requires an output destination
for each plugin invoked; you just want these to match:

.. code-block:: shell

  $ protoc google/cloud/vision/v1/*.proto \
      --python_out=/dest/ \
      --pyclient_out=/dest/

.. note::

  **A reminder about paths.**

  Remember that ``protoc`` is particular about paths. It expects to be run
  from the "base path" used for imports within the protos. If you are
  running ``protoc`` from any other location, you will need to provide
  ``--proto_path``.

Because the generator is experimental, you need to compile the experimental
version of google-common-protos as well:

.. code-block:: shell

  $ protoc google/api/*.proto \
      google/api/experimental/*.proto \
      google/api/expr/v1/*.proto \
      --python_out=/dest/ \

Create a blank file ``/dest/google/api/__init__.py`` to use ``google.api`` as a
package.

Running a Client Library
~~~~~~~~~~~~~~~~~~~~~~~~

Once you have compiled a client library, it is time for the fun part:
actually running it!

Create a virtual environment for the library:

.. code-block:: shell

  $ virtualenv ~/.local/client-lib --python=`which python3.6`
  $ source ~/.local/client-lib/bin/activate

Next, install the library:

.. code-block:: shell

  $ cd /dest/
  $ pip install --editable .

Now it is time to play with it!
Here is a test script:

.. code-block:: python

  # These are the compiled protocol buffer types generated by
  # `protoc --python_out`.
  from google.cloud.vision.v1 import image_annotator_pb2 as types

  # This is the client library generated by this plugin.
  from google.cloud.vision_v1 import image_annotator

  # Instantiate the client.
  #
  # If you need to manually specify credentials, do so here.
  # More info: https://cloud.google.com/docs/authentication/getting-started
  #
  # If you wish, you can send `transport='grpc'` or `transport='http'`
  # to change which underlying transport layer is being used.
  ia = image_annotator.ImageAnnotator()

  # Piece together the request object.
  request = types.BatchAnnotateImagesRequest(requests=[
      types.AnnotateImageRequest(
          features=[types.Feature(
              type=types.Feature.Type.Value('LABEL_DETECTION'),
          )],
          image=types.Image(source=types.ImageSource(
              image_uri='https://s3.amazonaws.com/cdn0.michiganbulb.com'
                        '/images/350/66623.jpg',
          )),
      ),
  ])

  # Send the request to the server and get the response.
  response = ia.batch_annotate_images(request)
  print(response)




.. _Google API design conventions: https://cloud.google.com/apis/design/

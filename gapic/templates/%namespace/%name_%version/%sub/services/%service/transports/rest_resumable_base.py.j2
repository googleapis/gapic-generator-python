{% import "%namespace/%name_%version/%sub/services/%service/_shared_macros.j2" as shared_macros %}
{% if service.has_resumable_upload %}
# -*- coding: utf-8 -*-
# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
import json  # type: ignore
import re
from typing import Any, Callable, Dict, List, Optional, Sequence, Tuple, Union

from google.api_core import gapic_v1, path_template
from google.protobuf import empty_pb2  # type: ignore
from google.protobuf import json_format

{% filter sort_lines %}
{% for method in service.methods.values() if method.is_resumable_upload %}
{{ method.input.ident.python_import }}
{{ method.output.ident.python_import }}
{% endfor %}
{% endfilter %}

from .base import DEFAULT_CLIENT_INFO, {{ service.name }}Transport

class _Base{{ service.name }}RestResumableTransport({{ service.name }}Transport):
    """Base REST Resumable backend transport for {{ service.name }}.

    Note: This class is not meant to be used directly. Only services that has RPCs
    that should be invoked as resumable upload should instantiate it and use it.
    """

    def __init__(
        self,
        *,
        host: str = "{{ service.host }}",
        credentials: Optional[Any] = None,
        client_info: gapic_v1.client_info.ClientInfo = DEFAULT_CLIENT_INFO,
        always_use_jwt_access: Optional[bool] = False,
        url_scheme: str = "https",
        api_audience: Optional[str] = None,
    ) -> None:
        """Instantiate the transport.
        Args:
            host (Optional[str]):
                 The hostname to connect to (default: '{{ service.host }}').
            credentials (Optional[Any]): The
                authorization credentials to attach to requests. These
                credentials identify the application to the service; if none
                are specified, the client will attempt to ascertain the
                credentials from the environment.
            client_info (google.api_core.gapic_v1.client_info.ClientInfo):
                The client info used to send a user-agent string along with
                API requests. If ``None``, then default info will be used.
                Generally, you only need to set this if you are developing
                your own client library.
            always_use_jwt_access (Optional[bool]): Whether self signed JWT should
                be used for service account credentials.
            url_scheme: the protocol scheme for the API endpoint.  Normally
                "https", but for testing or local servers,
                "http" can be specified.
        """
        # Run the base constructor
        maybe_url_match = re.match("^(?P<scheme>http(?:s)?://)?(?P<host>.*)$", host)
        if maybe_url_match is None:
            raise ValueError(
                f"Unexpected hostname structure: {host}"
            )  # pragma: NO COVER

        url_match_items = maybe_url_match.groupdict()

        host = f"{url_scheme}://{host}" if not url_match_items["scheme"] else host

        super().__init__(
            host=host,
            credentials=credentials,
            client_info=client_info,
            always_use_jwt_access=always_use_jwt_access,
            api_audience=api_audience,
        )

    {% for method in service.methods.values() if method.is_resumable_upload %}
    class _Base{{ method.name }}Request:
        def __hash__(self):  # pragma: NO COVER
            return NotImplementedError("__hash__ must be implemented.")
        
        {% set method_http_options = method.http_options %}
        {{ shared_macros.http_options_method(method_http_options)|indent(8) }}

        @staticmethod
        def _get_transcoded_request(http_options, request):
            {% if method.input.ident.is_proto_plus_type %}
            pb_request = {{method.input.ident}}.pb(request)
            {% else %}
            pb_request = request
            {% endif %}
            transcoded_request = path_template.transcode(http_options, pb_request)
            return transcoded_request

    {% endfor %}

__all__ = ("_Base{{ service.name }}RestResumableTransport",)
{% endif %}
